#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';;

use SeanKndy\AlertManager\Server;
use SeanKndy\AlertManager\Receivers\Group;
use SeanKndy\AlertManager\Receivers\Email;
use SeanKndy\AlertManager\Routing\Router;
use SeanKndy\AlertManager\Routing\Route;
use SeanKndy\AlertManager\Alerts\Alert;

$loop = \React\EventLoop\Factory::create();

$smtpConfig = ['server' => 'smtp.vcn.com', 'from' => 'alerts@vcn.com'];
$receiverA = new Email($loop, 'skennedy@office.vcn.com', $smtpConfig);
$receiverB = new Email($loop, 'sean@kndy.net', $smtpConfig);

$allReceivers = new Group([
    $receiverA, $receiverB
]);

// first route that matches stops the route chain
$router = (new Router())
    ->addRoute(Route::toDestination($receiverA)->where('service_id', 10))
    ->addRoute(Route::toDestination($receiverB)->where('port_id', 15))
    ->addRoute(Route::toDestination(null)->where('regex:location_name', '/^CLIENTS..+/'));

$server = new Server(
    '0.0.0.0:8000',
    $loop,
    $router
);

$loop->run();
