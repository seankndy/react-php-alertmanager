#!/usr/bin/env php
<?php
require __DIR__ . '/../src/inc/bootstrap.php';

use SeanKndy\AlertManager\Server;
use SeanKndy\AlertManager\Receivers\Group;
use SeanKndy\AlertManager\Receivers\Email;
use SeanKndy\AlertManager\Routing\Router;
use SeanKndy\AlertManager\Routing\LabelRoute;
use SeanKndy\AlertManager\Routing\NullRoute;

$loop = \React\EventLoop\Factory::create();

$receiverA = new Email('skennedy@office.vcn.com');
$receiverB = new Email('sean@kndy.net');

$allReceivers = new Group([
    $receiverA, $receiverB
]);

//
// first route that matches stops the route chain
//
$router = (new Router())
    ->addRoute(AttrRoute::define(['service_id' => 10], $receiverA))
    ->addRoute(AttrRoute::define(['port_id' => 15], $receiverB))
    ->addRoute(AttrRoute::define(['regex:locationname' => '/^CLIENTS..+/'], null))
    ->addRoute($allReceivers);


$server = new Server(
    '0.0.0.0:8000',
    $loop,
    $router
);

$loop->run();
