#!/usr/bin/env php
<?php
require __DIR__ . '/../src/inc/bootstrap.php';

use SeanKndy\AlertManager\Server;
use SeanKndy\AlertManager\Receivers\Group;
use SeanKndy\AlertManager\Receivers\Email;
use SeanKndy\AlertManager\Routing\Router;
use SeanKndy\AlertManager\Routing\Route;

$loop = \React\EventLoop\Factory::create();

$receiverA = new Email('skennedy@office.vcn.com');
$receiverB = new Email('sean@kndy.net');

$allReceivers = new Group([
    $receiverA, $receiverB
]);

//
// first route that matches stops the route chain
//
/*
$router = (new Router())
    ->addRoute(AttrRoute::define(['service_id' => 10], $receiverA))
    ->addRoute(AttrRoute::define(['port_id' => 15], $receiverB))
    ->addRoute(AttrRoute::define(['regex:locationname' => '/^CLIENTS..+/'], null));
//    ->addRoute($allReceivers);
*/


// should result in:
// (service_id in(10,15) or joe=blow or jim=queen) and (loc=gltt or loc=shrd)
/*
Route::destination($receiverA)
    ->where('service_id', [10,15])
    ->or('joe', 'blow')
    ->or('jim', 'queen')
    ->and('loc', 'gltt')
    ->or('loc', 'shrd')
    ->destination($receiverA);
*/

// (service_id in(10,15) and joe=blow and jim=queen) and (loc=gltt or loc=shrd)
print_r(Route::toDestination($receiverA)
    ->where('service_id', [10,15])
    ->where('joe', 'blow')
    ->where('jim', 'queen')
    ->where(function ($criteria) {
        return $criteria->where('loc', 'gltt')
            ->orWhere('loc', 'shrd');
    })
);

print_r(Route::toDestination($receiverA)
    ->where('service_id', [10,15])
    ->where('joe', 'blow')
    ->orWhere('jim', 'queen')
    ->where(function ($criteria) {
        return $criteria->where('age', 31)
            ->where('sex', 'male')
            ->orWhere('hair', 'brown');
    })
);


// (service_id in(10,15) or joe=blow or jim=queen) and (loc=gltt or loc=shrd)
print_r(Route::toDestination($receiverA)
    ->where('service_id', [10,15])
    ->orWhere('joe', 'blow')
    ->orWhere('jim', 'queen')
    ->where(function ($criteria) {
        return $criteria->where('loc', 'gltt')
            ->orWhere('loc', 'shrd')
            ->orWhere('loc', 'dnvr');
    })
);
/*
$server = new Server(
    '0.0.0.0:8000',
    $loop,
    $router
);

$loop->run();
*/
